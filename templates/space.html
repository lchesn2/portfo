{% extends "base.html" %}
{% set title = "Space Weather ‚Äî Larah" %}

{% block content %}

<div class="space-header">
  <div class="space-header__text">
    <h2>Space Weather Dashboard</h2>
    <p class="muted">Live data from NOAA's Space Weather Prediction Center ‚Äî solar wind, geomagnetic storms, aurora activity.</p>
  </div>
  <div class="space-header__right">
    <div class="space-badge">
      <span class="space-badge__dot" id="badge-dot"></span>
      <span class="space-badge__label" id="badge-label">
        {% if sw.fetched_at %}
          Updated {{ sw.fetched_at[:16] | replace("T", " ") }} UTC
        {% else %}
          NOAA SWPC API
        {% endif %}
      </span>
    </div>
    <button class="sw-refresh-btn" id="refresh-btn" onclick="refreshData()">
      &#8635; Refresh
    </button>
  </div>
</div>

<!-- Status strip -->
<div class="sw-status-row">
  <div class="sw-status-card">
    <div class="sw-status-label">Geomagnetic Storm</div>
    <div class="sw-status-value {{ 'sw-status--green' if sw.scales.G.scale in ['G0','‚Äî'] else 'sw-status--amber' if sw.scales.G.scale in ['G1','G2'] else 'sw-status--red' }}">
      {{ sw.scales.G.scale }} <span class="sw-status-sub">{{ sw.scales.G.label }}</span>
    </div>
  </div>
  <div class="sw-status-card">
    <div class="sw-status-label">Solar Radiation</div>
    <div class="sw-status-value {{ 'sw-status--green' if sw.scales.S.scale in ['S0','‚Äî'] else 'sw-status--amber' if sw.scales.S.scale in ['S1','S2'] else 'sw-status--red' }}">
      {{ sw.scales.S.scale }} <span class="sw-status-sub">{{ sw.scales.S.label }}</span>
    </div>
  </div>
  <div class="sw-status-card">
    <div class="sw-status-label">Radio Blackout</div>
    <div class="sw-status-value {{ 'sw-status--green' if sw.scales.R.scale in ['R0','‚Äî'] else 'sw-status--amber' if sw.scales.R.scale in ['R1','R2'] else 'sw-status--red' }}">
      {{ sw.scales.R.scale }} <span class="sw-status-sub">{{ sw.scales.R.label }}</span>
    </div>
  </div>
  <div class="sw-status-card">
    <div class="sw-status-label">Aurora Visibility</div>
    <div class="sw-status-value {{ 'sw-status--green' if sw.kp.current is none or sw.kp.current < 3 else 'sw-status--amber' if sw.kp.current < 6 else 'sw-status--red' }}">
      {% if sw.kp.current is not none %}
        Kp {{ sw.kp.current | round(1) }}
      {% else %}‚Äî{% endif %}
      <span class="sw-status-sub">{{ sw.aurora.label }}</span>
    </div>
  </div>
</div>

<!-- Main grid -->
<div class="sw-grid">

  <!-- Solar Wind panel -->
  <div class="sw-panel">
    <div class="sw-panel__header">
      <span class="sw-panel__icon">‚òÄÔ∏è</span>
      <div>
        <div class="sw-panel__title">Solar Wind</div>
        <div class="sw-panel__sub">Speed ¬∑ Density ¬∑ Bz field (DSCOVR)</div>
      </div>
    </div>
    <div class="sw-metrics">

      <!-- Speed -->
      <div class="sw-metric">
        <div class="sw-metric__val">
          {% if sw.solar_wind.speed is not none %}
            {{ sw.solar_wind.speed | int }} <span class="sw-metric__unit">km/s</span>
          {% else %}<span class="sw-metric__unit">‚Äî</span>{% endif %}
        </div>
        <div class="sw-metric__label">Wind Speed</div>
        {% if sw.solar_wind.speed is not none %}
          {% set speed_pct = ((sw.solar_wind.speed / 800) * 100) | int %}
          {% set speed_pct = 100 if speed_pct > 100 else speed_pct %}
          <div class="sw-bar-track">
            <div class="sw-bar-fill" style="width: {{ speed_pct }}%; background: var(--moss-mid);"></div>
          </div>
        {% endif %}
      </div>

      <!-- Density -->
      <div class="sw-metric">
        <div class="sw-metric__val">
          {% if sw.solar_wind.density is not none %}
            {{ sw.solar_wind.density }} <span class="sw-metric__unit">p/cm¬≥</span>
          {% else %}<span class="sw-metric__unit">‚Äî</span>{% endif %}
        </div>
        <div class="sw-metric__label">Density</div>
        {% if sw.solar_wind.density is not none %}
          {% set density_pct = ((sw.solar_wind.density / 50) * 100) | int %}
          {% set density_pct = 100 if density_pct > 100 else density_pct %}
          <div class="sw-bar-track">
            <div class="sw-bar-fill" style="width: {{ density_pct }}%; background: var(--moss-mid);"></div>
          </div>
        {% endif %}
      </div>

      <!-- Bz -->
      <div class="sw-metric">
        <div class="sw-metric__val">
          {% if sw.solar_wind.bz is not none %}
            {{ sw.solar_wind.bz }} <span class="sw-metric__unit">nT</span>
          {% else %}<span class="sw-metric__unit">‚Äî</span>{% endif %}
        </div>
        <div class="sw-metric__label">Bz (IMF) ‚Äî negative = storm risk</div>
        {% if sw.solar_wind.bz is not none %}
          {% set bz_mag = sw.solar_wind.bz if sw.solar_wind.bz >= 0 else sw.solar_wind.bz * -1 %}
          {% set bz_pct = ((bz_mag / 30) * 100) | int %}
          {% set bz_pct = 100 if bz_pct > 100 else bz_pct %}
          {% set bz_color = '#9a6e00' if sw.solar_wind.bz < -10 else 'var(--moss-mid)' %}
          <div class="sw-bar-track">
            <div class="sw-bar-fill" style="width: {{ bz_pct }}%; background: {{ bz_color }};"></div>
          </div>
        {% endif %}
      </div>

    </div>

    <!-- Sparkline: Kp history trend -->
    {% if sw.kp.history and sw.kp.history | length > 1 %}
    <div class="sw-chart-placeholder">
      {% set pts = sw.kp.history %}
      {% set pt_count = pts | length %}
      <svg viewBox="0 0 280 60" class="sw-sparkline">
        <polyline
          points="{% for pt in pts %}{{ ((loop.index0 / (pt_count - 1)) * 280) | int }},{{ (60 - (pt.kp / 9 * 50)) | int }} {% endfor %}"
          fill="none" stroke="var(--moss-mid)" stroke-width="1.8"
          stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <div class="sw-chart-label">recent Kp index trend</div>
    </div>
    {% endif %}
  </div>

  <!-- Kp Index / Aurora panel -->
  <div class="sw-panel">
    <div class="sw-panel__header">
      <span class="sw-panel__icon">üåå</span>
      <div>
        <div class="sw-panel__title">Kp Index</div>
        <div class="sw-panel__sub">Planetary geomagnetic activity</div>
      </div>
    </div>
    <div class="sw-kp-scale">
      {% set current_kp = sw.kp.current if sw.kp.current is not none else 0 %}
      {% for i in range(1, 10) %}
        <div class="sw-kp-bar {% if i <= current_kp %}sw-kp--active{% endif %}"
             style="height: {{ 20 + i * 8 }}px;"
             title="Kp {{ i }}">
          <span class="sw-kp-num">{{ i }}</span>
        </div>
      {% endfor %}
    </div>
    <div class="sw-kp-legend">
      <span class="sw-kp-legend-item sw-kp-legend--green">‚óè G0‚ÄìG1 Quiet</span>
      <span class="sw-kp-legend-item sw-kp-legend--amber">‚óè G2‚ÄìG3 Active</span>
      <span class="sw-kp-legend-item sw-kp-legend--red">‚óè G4‚ÄìG5 Storm</span>
    </div>
    <div class="sw-aurora-note">
      <span class="sw-aurora-dot"></span>
      {{ sw.aurora.label }}
    </div>
  </div>


  <!-- Alerts panel -->
  <div class="sw-panel sw-panel--wide">
    <div class="sw-panel__header">
      <span class="sw-panel__icon">üì°</span>
      <div>
        <div class="sw-panel__title">Active Alerts</div>
        <div class="sw-panel__sub">NOAA SWPC warnings & watches</div>
      </div>
    </div>
    {% if sw.alerts %}
      <div class="sw-alerts-list">
        {% for alert in sw.alerts %}
        <div class="sw-alert-item">
          <div class="sw-alert-meta">
            <span class="sw-pill {{ 'sw-pill--amber' if 'WARNING' in alert.headline else 'sw-pill--red' if 'WATCH' in alert.headline else 'sw-pill--green' }}">
              {{ alert.product_id | replace('_', ' ') }}
            </span>
            <span class="sw-alert-time">
              {% if alert.issue_time %}{{ alert.issue_time[:16] | replace("T", " ") }} UTC{% endif %}
            </span>
          </div>
          <div class="sw-alert-headline">{{ alert.headline }}</div>
          {% if alert.impacts %}
          <div class="sw-alert-impacts">‚ö° {{ alert.impacts }}</div>
          {% endif %}
        </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="sw-aurora-note" style="margin-top:0;">
        <span class="sw-aurora-dot" style="background:var(--moss-mid);"></span>
        No active alerts ‚Äî conditions are quiet.
      </div>
    {% endif %}
  </div>

</div>


<script>
// ‚îÄ‚îÄ Terminal helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openTerminal() {
  document.getElementById('terminal-body').innerHTML = '';
  document.getElementById('terminal-overlay').classList.add('sw-terminal-overlay--show');
}
function closeTerminal(e) {
  // only close if clicking the backdrop, not the terminal box itself
  if (e && e.target !== document.getElementById('terminal-overlay')) return;
  document.getElementById('terminal-overlay').classList.remove('sw-terminal-overlay--show');
}
function termLog(msg, cls) {
  const body = document.getElementById('terminal-body');
  const line = document.createElement('div');
  line.className = 'sw-terminal__line' + (cls ? ' ' + cls : '');
  line.textContent = msg;
  body.appendChild(line);
  body.scrollTop = body.scrollHeight;
}
function termDelay(ms) { return new Promise(r => setTimeout(r, ms)); }

// ‚îÄ‚îÄ Simulated log sequence (runs in parallel with real fetch) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function runTerminalLogs(resultPromise) {
  const now = () => new Date().toISOString().substring(11,19);

  termLog('$ python space_weather.py', 'sw-t-cmd');
  await termDelay(180);
  termLog(`[${now()}] INFO  Starting NOAA SWPC fetch...`);
  await termDelay(300);
  termLog(`[${now()}] INFO  GET solar-wind/plasma-2-hour.json`);
  await termDelay(420);
  termLog(`[${now()}] INFO  GET solar-wind/mag-2-hour.json`);
  await termDelay(380);
  termLog(`[${now()}] INFO  GET products/noaa-planetary-k-index.json`);
  await termDelay(350);
  termLog(`[${now()}] INFO  GET products/noaa-scales.json`);
  await termDelay(300);
  termLog(`[${now()}] INFO  GET products/alerts.json`);
  await termDelay(250);
  termLog(`[${now()}] INFO  Parsing solar wind plasma...`);
  await termDelay(180);
  termLog(`[${now()}] INFO  Parsing magnetometer (Bz)...`);
  await termDelay(160);
  termLog(`[${now()}] INFO  Parsing Kp index...`);
  await termDelay(140);
  termLog(`[${now()}] INFO  Parsing NOAA storm scales...`);
  await termDelay(120);
  termLog(`[${now()}] INFO  Parsing active alerts...`);
  await termDelay(200);

  // Wait for the real fetch to finish
  const result = await resultPromise;

  if (result.ok) {
    const ts = result.fetched_at || '';
    termLog(`[${now()}] INFO  Writing cache ‚Üí static/data/space_weather_cache.json`);
    await termDelay(150);
    termLog(`[${now()}] INFO  wind: ${result.solar_wind_speed ?? '‚Äî'} km/s  Bz: ${result.bz ?? '‚Äî'} nT  Kp: ${result.kp ?? '‚Äî'}  G-scale: ${result.g_scale ?? '‚Äî'}`);
    await termDelay(120);
    termLog(`[${now()}] INFO  Done. fetched_at=${ts.substring(0,19).replace('T',' ')} UTC`, 'sw-t-ok');
    await termDelay(200);
    termLog(`[${now()}] INFO  Reloading page...`, 'sw-t-ok');
    await termDelay(900);
    window.location.reload();
  } else {
    termLog(`[${now()}] ERROR ${result.error || 'Fetch failed'}`, 'sw-t-err');
    await termDelay(200);
    termLog(`[${now()}] ERROR Refresh aborted. Check NOAA API connectivity.`, 'sw-t-err');
  }
}

// ‚îÄ‚îÄ Main refresh function ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function refreshData() {
  const btn = document.getElementById('refresh-btn');
  const dot = document.getElementById('badge-dot');

  btn.disabled         = true;
  btn.textContent      = '‚è≥ Fetching...';
  dot.style.background = '#c8a400';

  openTerminal();

  // Kick off real fetch ‚Äî don't await yet, let terminal logs run in parallel
  const fetchPromise = fetch('/space/refresh', { method: 'POST' })
    .then(r => r.json())
    .catch(e => ({ ok: false, error: e.message }));

  // Run logs alongside the fetch
  await runTerminalLogs(fetchPromise);

  // If failed, re-enable button
  const result = await fetchPromise.catch(() => ({ ok: false }));
  if (!result.ok) {
    btn.disabled    = false;
    btn.textContent = '‚Üª Retry';
    dot.style.background = '#b83232';
  }
}
</script>

<!-- Terminal modal -->
<div class="sw-terminal-overlay" id="terminal-overlay" onclick="closeTerminal(event)">
  <div class="sw-terminal" id="terminal-box">
    <div class="sw-terminal__bar">
      <span class="sw-terminal__dot sw-terminal__dot--red"></span>
      <span class="sw-terminal__dot sw-terminal__dot--amber"></span>
      <span class="sw-terminal__dot sw-terminal__dot--green"></span>
      <span class="sw-terminal__title">noaa_fetch.py</span>
    </div>
    <div class="sw-terminal__body" id="terminal-body"></div>
  </div>
</div>

{% endblock %}